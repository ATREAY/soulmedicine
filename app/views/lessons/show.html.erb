<%= render "courses/check_available", course: @course do %>
  <%
    title @lesson.name + ' | ' + @course.name
    description @lesson.content
    set_meta_tags image_src: @course.image
  %>

  <nav aria-label="breadcrumb" class="<%= text_direction -%> <%= language_class -%>" dir="<%= text_direction -%>">
    <ol class="breadcrumb breadcrumb-notes">
      <li class="breadcrumb-item d-flex align-items-center">
        <%= image_tag @course.image,
            style: 'width: 100px;',
            alt: @course.summary %>
        <%= link_to tc(@course.name),
            course_path(@course),
            class: 'flex-grow-1' %>
      </li>
    </ol>
  </nav>
  <div class='my-4 p-3'>
    <% if @previous_lesson.present? %>
      <%= link_to sanitize('&lt;&lt; Previous'), course_lesson_path(@course, @previous_lesson), class: 'float-left' %>
    <% end %>
    <% if @next_lesson.present? %>
      <%= link_to sanitize('Next &gt;&gt;'), course_lesson_path(@course,@next_lesson), class: 'float-right' %>
    <% end %>
  </div>
  <section class="lesson-page">
    <div class="card <%= text_direction -%>" dir="<%= text_direction -%>">
      <div class="card-header">
        <ul class="nav nav-pills card-header-pills" role="tablist">
          <li class="nav-item">
            <!-- Current language tab -->
            <a class="nav-link active" id="nav-lesson-content-<%= LocalesService.current -%>" data-toggle="tab" href="#lesson-content-<%= LocalesService.current -%>" role="tab" aria-controls="lesson-content-<%= LocalesService.current -%>" aria-selected="true">
              <%= LocalesService.language_name(LocalesService.current) %>
            </a>
          </li>

          <% if @course.enabled_languages.size > 1 %>
            <li class="nav-item nav-link text-primary">â”†</li>
          <% end %>

          <!-- Other languages tabs -->
          <% @course.enabled_languages.each do |l| %>
            <% if l != LocalesService.current.to_s %>
              <li class="nav-item">
                <a class="nav-link" id="nav-lesson-content-<%= l -%>" data-toggle="tab" href="#lesson-content-<%= l -%>" role="tab" aria-controls="lesson-content-<%= l -%>" aria-selected="false">
                  <%= LocalesService.language_name(l) %>
                </a>
            </li>
            <% end %>
          <% end %>
        </ul>
      </div>
      <div class="card-body tab-content">
        <!-- Current language content -->
        <div class="tab-pane fade show active <%= text_direction -%> <%= language_class -%>" id="lesson-content-<%= LocalesService.current -%>" dir="<%= text_direction -%>">
          <h2 class="<%= text_direction -%> <%= language_class -%>" dir="<%= text_direction -%>">
            <%= tc(@lesson.name) %>
          </h2>
          <div>
            <%== tc(@lesson.content) %>
          </div>
        </div>

        <!-- Other languages content -->
        <% @course.enabled_languages.each do |l| %>
          <% if l != LocalesService.current.to_s %>
            <% LocalesService.with(l) do %>
              <div class="tab-pane fade <%= text_direction -%> <%= language_class -%>" id="lesson-content-<%= l -%>" role="tabpanel" aria-labelledby="nav-home-tab" dir="<%= text_direction -%>">
                <h2 class="<%= text_direction -%> <%= language_class -%>" dir="<%= text_direction -%>">
                  <%= tc(@lesson.name) %>
                </h2>
                <div>
                  <%== tc(@lesson.content) %>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
      <div class="card-footer">
        <% if @reaction && current_user? %>
          <div class='col text-right'>
            <h5 class='my-1 pr-2'>You said this note made you feel empowered
              <span class='px-2' data-toggle="tooltip" data-placement="top" title="You said this note made you feel empowered."><%= emojify(':crown:') %></span>
            </h5>
            <p class='mt-4'>Change your reaction:
              <span class='px-2' data-toggle="tooltip" data-placement="top" title="You said this note made you feel strong."><%= emojify(':muscle:') %></span>
              <span class='px-2' data-toggle="tooltip" data-placement="top" title="You said this note made you feel knowledable."><%= emojify(':brain:') %></span>
              <span class='px-2' data-toggle="tooltip" data-placement="top" title="You said this note made you feel magical."><%= emojify(':unicorn:') %></span>
              <span class='px-2' data-toggle="tooltip" data-placement="top" title="You said this note made you feel peaceful."><%= emojify(':dove:') %></span>
            </p>
          </div>
        <% elsif current_user? %>
          <div class='row float-right align-middle'>
            <h6 class='my-1 pr-4'>How does this note make you feel?</h6>
            <% @possible_reactions.each do |r| %>
              <%= link_to course_lesson_reaction_path(@course, @lesson, reaction_name: r),
                  method: reaction_method(current_user, @course.slug, @lesson.slug),
                  remote: true do %>
                  <%= content_tag(:span, emojify(":#{r}:"),
                    title: r.to_s.capitalize,
                    class: 'px-2',
                    "data-toggle": "tooltip",
                    "data-placement": "top") %>
              <% end %>
            <% end %>
          </div>
      <% else %>
        <h6 class='my-2'>To get these notes emailed directly to you
          <%=
            link_to(
              "create an subscription.",
              course_subscription_path(@course),
            )
          %>
        </h6>
        <h6 class='my-2'>Or you can
          <%#  Todo: need to add correct forwarding URL here %>
          <%=
            link_to(
              "sign in",
              auth_sign_in_path(course_id: @course.to_param),
            )
          %>
          to keep track of your reactions to each note and monitor your progress.
        </h6>
        <% end %>
      </div>
    </div>
  </section>
  <div class='my-4 p-3'>
    <% if @previous_lesson.present? %>
      <%= link_to sanitize('&lt;&lt; Previous'), course_lesson_path(@course, @previous_lesson), class: 'float-left' %>
    <% end %>
    <% if @next_lesson.present? %>
      <%= link_to sanitize('Next &gt;&gt;'), course_lesson_path(@course,@next_lesson), class: 'float-right' %>
    <% end %>
  </div>
<% end %>
